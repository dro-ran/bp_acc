<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>BP_Clock</title>
    <style>
        #clock {
            top: 0;
            left: 0;
        }

        #pip_button {
            /* margin-top: 310px; */
            display: flex;
            padding: 10px 90px;
            text-align: center;
        }

        #tw_link {
            font-size: 10pt;
            position: fixed;
            left: 0;
            bottom: 0;
        }
    </style>
</head>

<body>
    <!-- å®Ÿéš›ã®clockæç”» -->
    <canvas id="clock" width="300" height="300"></canvas>
    <!-- PiPç”¨ã«canvasã‚’ãƒŸãƒ©ãƒ¼ã™ã‚‹video å®Ÿéš›ã®è¡¨ç¤ºã¯ã„ã‚‰ãªã„ã®ã§hidden -->
    <video hidden id="clock_v" width="300" height="300"></video>
    <!-- PiPç”¨ã®ãƒœã‚¿ãƒ³ -->
    <input type="button" id="pip_button" value="PiPã§ãƒãƒƒãƒ—ã‚¢ã‚¦ãƒˆ">
    <!-- å®£ä¼ -->
    <a id="tw_link" href="https://twitter.com/dro_ran_bp">@dro_ran_bp</a>

    <script>
        function to_two_digits(val){
            /* äºŒæ¡ã®stringã«ã™ã‚‹ */
            return ("00" + val).slice(-2);
        }

        function to_canvas_arc_rad(deg) {
            /* canvas arcä¸Šã§ã¯90åº¦å³å›žè»¢ã—ã¦ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ãªã®ã§90åº¦åˆ†ä½™è¨ˆã«å‹•ã‹ã™ */
            return (deg - 90) * Math.PI / 180;
        }

        function get_raid_time(cur_date) {
            const monday_raid_time = [1, 14, 18, 22];
            const normal_raid_time = [14, 18, 22];
            const saturday_raid_time = [8, 12, 16, 20];
            const sunday_raid_time = [1, 8, 12, 16, 20];

            var is_raid_time = false;
            var left_hour;
            var left_min;
            var left_sec;
            var raid_time_arr;
            var next_raid_time_arr;

            /* æ›œæ—¥ã«ã‚ˆã£ã¦ä½¿ã†é…åˆ—ã‚’é¸ã¶ */
            switch (cur_date.getDay()) {
                case 0:
                    raid_time_arr = sunday_raid_time;
                    next_raid_time_arr = monday_raid_time;
                    break;
                case 1:
                    raid_time_arr = monday_raid_time;
                    next_raid_time_arr = normal_raid_time;
                    break;
                case 2:
                case 3:
                case 4:
                    raid_time_arr = normal_raid_time;
                    next_raid_time_arr = normal_raid_time;
                    break;
                case 5:
                    raid_time_arr = normal_raid_time;
                    next_raid_time_arr = saturday_raid_time;
                    break;
                case 6:
                    raid_time_arr = saturday_raid_time;
                    next_raid_time_arr = sunday_raid_time;
                    break;
                default:
                    /* ã‚ã‚Šãˆãªã„ã‚±ãƒ¼ã‚¹ã ã‘ã©ä¸€å¿œç½®ã„ã¨ã */
                    raid_time_arr = normal_raid_time;
                    next_raid_time_arr = normal_raid_time;
                    break;
            }

            /* æ¬¡ã®ãƒ¬ã‚¤ãƒ‰æ™‚é–“ã«å½“ãŸã‚‹æ™‚åˆ»ã‚’å–å¾—ã™ã‚‹ */
            const next_raid_hour = raid_time_arr.reduce((a, b) => {
                if (a == cur_date.getHours()) {
                    is_raid_time = true;
                    return a;
                } else if (b == cur_date.getHours()) {
                    is_raid_time = true;
                    return b;
                } else if (a > cur_date.getHours()) {
                    is_raid_time = false;
                    return a;
                }  else if (b > cur_date.getHours()) {
                    is_raid_time = false;
                    return b;
                } else {
                    is_raid_time = false;
                    return b;
                }
            });

            if (is_raid_time) {
                left_hour = 0;
            } else if ((next_raid_hour - cur_date.getHours() - 1) < 0) {
                /* æ—¥ä»˜ã¾ãŸã„ã§æ¬¡ã®ãƒ¬ã‚¤ãƒ‰ãŒã‚ã‚‹å ´åˆ */
                left_hour = 23 - cur_date.getHours() + next_raid_time_arr[0];
            } else {
                left_hour = next_raid_hour - cur_date.getHours() - 1;
            }
            /* 0åˆ†0ç§’ã‚¹ã‚¿ãƒ¼ãƒˆãªã®ã§ã“ã“ã¯è€ƒãˆã‚‹å¿…è¦ãªã— */
            left_min = 59 - cur_date.getMinutes();
            left_sec = 59 - cur_date.getSeconds();

            return [is_raid_time, left_hour, left_min, left_sec];
        }

        function get_reg_time(cur_date) {
            const base_date = new Date(cur_date);
            const end_date = new Date(cur_date);

            var is_special_time_area = false;
            var is_night = false;
            var left_min = 0;
            var left_min = 0;
            var half_day_sec = 1500;

            /* æ™‚é–“ã®èµ·ç‚¹ */
            base_date.setHours(9);
            base_date.setMinutes(42);
            base_date.setSeconds(10);
            base_date.setMilliseconds(0);

            /* æ™‚é–“ã®çµ‚ç‚¹ */
            end_date.setHours(9);
            end_date.setMinutes(27);
            end_date.setSeconds(10);
            end_date.setMilliseconds(0);

            /* 0 - 8:57:10:00ã¯é–‹å§‹æ™‚ãŒ1æ—¥å‰ */
            if (cur_date.getTime() < end_date.getTime()) {
                base_date.setDate(base_date.getDate() - 1);
            }

            /* èµ·ç‚¹çµ‚ç‚¹é–“ã®15åˆ†ã¯ç‰¹æ®Šãªã®ã§æ‰±ã„ã‚’å¤‰ãˆã‚‹ */
            if (cur_date.getTime() >= end_date.getTime()) {
                if (cur_date.getTime() < base_date.getTime()) {
                    is_special_time_area = true;
                }
            }

            if (is_special_time_area) {
                const cyc_ela_date = new Date(cur_date.getTime() - end_date.getTime());
                half_day_sec = 900; // 15åˆ†
                is_night = true;    // ã“ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¯å¸¸ã«å¤œ
                /* ç¾ã‚µã‚¤ã‚¯ãƒ«ã®çµŒéŽæ™‚é–“ */
                left_min = 14 - cyc_ela_date.getMinutes();
                left_sec = 59 - cyc_ela_date.getSeconds();
            } else {
                var time_cicle = 0;
                const ela_msec = cur_date.getTime() - base_date.getTime();  // 1æ—¥ã®å§‹ã¾ã‚Šã‹ã‚‰ã©ã‚Œã ã‘çµŒéŽã—ãŸã‹
                half_day_sec = 1500;    // 25åˆ†
                time_cicle = Math.floor(ela_msec / (half_day_sec * 1000));
                is_night = time_cicle % 2;

                /* ç¾ã‚µã‚¤ã‚¯ãƒ«ã®é–‹å§‹æ™‚é–“ */
                const cyc_start_date = new Date(time_cicle * half_day_sec * 1000 + base_date.getTime());
                /* ç¾ã‚µã‚¤ã‚¯ãƒ«ã®çµŒéŽæ™‚é–“ */
                const cyc_ela_date = new Date(cur_date.getTime() - cyc_start_date.getTime());

                /* ç¾ã‚µã‚¤ã‚¯ãƒ«ã®æ®‹ã‚Šæ™‚é–“ */
                left_min = 24 - cyc_ela_date.getMinutes();
                left_sec = 59 - cyc_ela_date.getSeconds();
            }

            return [half_day_sec, is_night, left_min, left_sec];
        }

        function upd_clock() {
            const cur_date = new Date();
            var time_emoji = "â“"

            /* ä¸€æ—¦ç¾ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‹ã‚‰è¦‹ã¦UTC+0ã«ã—ã¦ã‹ã‚‰JST(UTC+9)ã«å¤‰æ›ã™ã‚‹ */
            cur_date.setTime(cur_date.getTime() + cur_date.getTimezoneOffset() * 60 * 1000);
            cur_date.setTime(cur_date.getTime() + 540 * 60 * 1000);

            /* æ˜¼å¤œã¨ç¾åœ¨ã®ã‚µã‚¤ã‚¯ãƒ«æ®‹ã‚Šæ™‚é–“ã¨1ã‚µã‚¤ã‚¯ãƒ«ã‚ãŸã‚Šæ™‚é–“ã‚’å–å¾— */
            [half_day_sec, is_night, left_min, left_sec] = get_reg_time(cur_date);
            /* ãƒ¬ã‚¤ãƒ‰ä¸­ã‹ã©ã†ã‹ã¨æ®‹ã‚Šæ™‚é–“ã‚’å–å¾— */
            [is_raid_time, raid_left_hour, raid_left_min, raid_left_sec] = get_raid_time(cur_date);

            /* è¡¨ç¤ºç”¨äºŒæ¡åŸ‹ã‚ */
            const left_time_str = to_two_digits(left_min) + ":" + to_two_digits(left_sec);
            const raid_left_time_str = to_two_digits(raid_left_hour) + ":" + to_two_digits(raid_left_min) + ":" + to_two_digits(raid_left_sec);
            const esp_sec = half_day_sec - (left_min * 60 + left_sec);
            const half_day_deg = (esp_sec % half_day_sec / half_day_sec * 360);

            if (is_night) {
                time_emoji = "ðŸŒ™"
            } else {
                time_emoji = "ðŸŒž"
            }

            /* ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã«ã‚µã‚¤ã‚¯ãƒ«æ®‹ã‚Šæ™‚é–“ã‚’æ›¸ã */
            document.title = time_emoji + ":" + left_time_str;

            /* canvasæç”» */
            const canvas = document.querySelector('#clock');
            ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = 'rgb(0, 0, 0)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = "white";
            ctx.textBaseline = "middle";
            ctx.textAlign = "center";
            ctx.font = "68px sans-serif";
            ctx.fillText(time_emoji, 150, 110);

            ctx.fillStyle = "white";
            ctx.font = "bold 26px sans-serif";
            ctx.fillText(left_time_str, 150, 170);

            ctx.font = "bold 16px sans-serif";
            if (is_raid_time) {
                ctx.fillStyle = "red";
                ctx.fillText("ãƒ¬ã‚¤ãƒ‰ä¸­:" + raid_left_time_str, 150, 200);
            } else {
                ctx.fillStyle = "white";
                ctx.fillText("ãƒ¬ã‚¤ãƒ‰ã¾ã§:" + raid_left_time_str, 150, 200);
            }

            ctx.beginPath();
            ctx.strokeStyle = "white";
            ctx.lineWidth = 18;
            ctx.arc(150, 150, 120, to_canvas_arc_rad(0), to_canvas_arc_rad(half_day_deg), false);
            ctx.stroke();

            setTimeout(upd_clock, 1000);
        }

        function view_init() {
            const canvas = document.querySelector('#clock');
            const video = document.querySelector('#clock_v');

            /* canvasä¸Šã®è¡¨ç¤ºã‚’ãã®ã¾ã¾videoã«é€ã‚‹ */
            video.srcObject = canvas.captureStream();
            video.muted = true; // è‡ªå‹•å†ç”Ÿã«å¿…è¦ã‚‰ã—ã„ãŒãªãã¦ã‚‚å‹•ä½œã™ã‚‹ã£ã½ã„
            video.play();
        }

        function pip_init() {
            const pip_button = document.querySelector('#pip_button');
            const video = document.querySelector('#clock_v');
            pip_button.addEventListener('click', function () {
                video.requestPictureInPicture();
            });
        }

        function main() {
            view_init();
            pip_init();
            upd_clock();
        }

        main();
    </script>
</body>

</html>
